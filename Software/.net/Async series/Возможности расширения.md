---
date: 2023-11-02
---
# Возможности расширения

Целесообразность этого вызывает вопросы, но можно:

1. создать кастомный *awaiter*
Чтобы тип данных можно было await'ить нужно, чтобы компилятор смог найти у него метод или метод расширения ```GetAwaiter()```. Возвращаемый этим методом тип должен удовлетворять условиям:
    - реализовывать ```INotifyCompletion```
    - должен иметь свойство ```bool IsCompleted {get;}``` и метод ```T GetResult()```
Но async методы могут возвращать только ```void, Task, Task<T>``` (см [[Antipatterns]] насчет ```async void```). Чтобы асинхронный метод мог возвращать кастомный тип нужно *Task-like* тип.

1. создать *Task-like* тип. [Здесь](https://ru.stackoverflow.com/a/658614/208118) описаны шаги для его создания.
Основной смысл создания таких типов(а именно структур) - избежать создания объекта, т.е. избежать выделения(allocation) памяти в управляемой куче, т.к. это связано с расходом ресурсов памяти и времени. Предпринимать это имеет смысл, когда речь идет о большом количестве асинхронных операций в единицу времени, скорее всего это какой-то инфраструктурный код.

Но в C#7 представлена структура ```ValueTask<T>```, которая, фактически, уже позволяет избежать избыточного выделения памяти в управляемой куче, когда в момент ```await```'a результат доступен синхронно. Это, например, можно использовать при возврате из кэша, организованного в памяти. Делаем возвращаемым типом метода структуру ```ValueTask<T>```. Зашли в асинхронный метод, проверили кэш, если есть нужное значение, вернули результат, обернув его в ```ValueTask```. Если нет - то тогда уже вызывается асинхронный метод получения нужных данных.

Ограничения при работе с ```ValueTask```:

1. Only Consume Once. Под *consume* понимается await или преобразование к ссылочной Task - AsTask(). Связно это ограничение с тем, что ValueTask может переиспользоваться после "потребления", если попытаемся потребить повторно, то она может уже предтавлять совершенно другую задачу.
1. Only Consume Asynchronously. Результат синхронного ожидания непредопределен.

---

## Источники

1. [Extending the async methods in c#](https://blogs.msdn.microsoft.com/seteplia/2018/01/11/extending-the-async-methods-in-c/)

## Ссылки

1. [Value Task by Stephen Cleary](https://blog.stephencleary.com/2020/03/valuetask.html)
