---
date: 2023-08-18
---
# CAP theorem

Как уже упоминалось выше любая [[Software/Architecture/Distributed systems/Consistency models/Basics|модель]] согласованности имеет свою *Synchronization cost*. Например, для реализации модели с более строгой согласованностью может потребоваться более интенсивный обмен сообщениями между репликами, что повышает трафик и latency и таким образом увеличивает стоимость синхронизаци по сравнению с моделью, имеющей более слабую согласованность.

Помимо sync cost согласованность вступает в противоречие с двумя другими важными характеристиками: *availability* и *network partition tolerance*.

**Availability** - способоность системы ответить на **все** запросы
**Network partition tolerance** - способность системы сохранить работоспособности при возникновении разделения сети, когда одна часть кластера становится недоступной для другой части.

Противоречия, которые образуют перечисленные характеристики, выражаются *CAP теоремой*. Она утверждает то, что в распределенной системе нельзя получить все три характеристики одновременно и придется выбрать только 2 из трех.

На самом деле невозможно исключить возможность network partition в распределнной системе, поэтому для сохранения работоспособности нужно, чтобы система была partition tolerance. Это значит, что кол-во сочетаний из CAP сокращается до двух:

1. **CP**: на каждую операцию(как чтение так и запись) можно запускать алгоритм консенсуса или брать распределенную блокировку. Жертвование А означает, что система может отвечать отказом на некоторые запросы пользователя. Например не будет принимать несколько параллельных операций по одному ключу.
1. **AP**: система будет отвечать теми данными, что есть, если хотя бы одна нода останется доступной. Но при этом не гарантируется, согласованность данных, потому что например на запрос чтения может ответить нода, на которой нет самых последних обновлений.

> better way of phrasing CAP would be either Consistent or Available when Partitioned [2]

## Нюансы CAP

Network partition tolerance подразумевает именно разделение сети. Т.е. под этот критерий не попадают отказы отдельных нод, а значит подразумевается, что способность переживать отказы отдельных нод никак не коррелирует с *A* и *C*. Однако **на практике отказы отдельных нод можно смоделировать через разделение сети**.

Consistency является перегруженным по смыслу понятием, которое очень зависит от контекста. В САP под *consistency*  подразумевают конкретную consistency model - [[Linearizability]]. Эта модель является самой строгой(за исключением теоретической *Strict consistency*), а значит, выбирая более слабые модели согласованности можно получить не такое бескомпромисное сочетание как предлагает CAP.
Кроме этого в теореме рассматривается только одна из возможных проблем в распределенной системе: разделение сети. И игнорируются, возможно более актуальные, проблемы unbounded delays, отказавшие ноды и др.
Т.о. теорема рассматривает только одну модель согласованности и одну возможную проблему, что сильно сужает возможность использования теоремы.

На практике при построении распределенной системы никто намеренно не жертвует ни *A*, ни *C*. В штатном режиме обе этих характеристики могут выполняться. Вопрос возникает как ведет себя система(какие гарантии выполняет, а какими жертвует) именно в условиях network partition, которое является нештатным, но тем не менее неизбежным в большой распределенной системе.

> a better way of phrasing CAP would be either Consistent or Available when Partitioned [2]

### CAP and network delays

> Linearizability is slow — and this is true all the time, not only during a network fault...if you want linearizability, the response time of read and write requests is at least proportional to the uncertainty of delays in the network [2]

Поэтому согласно [2] на практике системы, не поддерживающие линеаризуемость, жертувуют ей не ради достижения *availability* / *fault tolerance*, а в первую очередь для повышения [[Performance]]. Точно также ради повышения производительности [[Linearizability|CPU не обеспечивают линеаризуемость]].
Поэтому жертвование *C* ради *A* является частным случаем.

## Зачем же все-таки нужна CAP

CAP можно представить как [[System model|system model]], которая представляет некоторую абстракцию. Она справедлива не для всех возможных в реальности случаев, но тем не менее полезна на определенном уровне, потому что за счет упрощения позволяет снизить сложность работы с распределенной системой:

1. explain distributed systems
1. reason about failure scenarios
1. evaluate possible situations

## Альтернатива

[[Harvest and Yield model]]

---

## Источники

1. [[Database Internals book]]. Replication and Consistency.
1. [[Designing Data-Intensive Applications book]]. Chapter 9

## Ссылки

1. [Kleppmann. Please stop calling databases CP or AP](https://martin.kleppmann.com/2015/05/11/please-stop-calling-databases-cp-or-ap.html)
1. [[Consistency: CAP vs ACID]]
1. [[Availability]]
