---
date: 2023-08-22
---
# Rebalancing

> The process of *moving load* from one *node* in the cluster to another is called rebalancing.

То есть в случае ребалансировки мы оперируем нагрузкой не на партиции, а в первую очередь на ноды. А split/merge партиций - это не цель, а способ управлять нагрузкой на ноды, потому что например переносить между нодами мы можем только партиции целиком.

Причины, когда необходимо перенаправлять нагрузку:

1. увеличивается кол-во запросов и мы хотим добавить CPU
1. увеличивается объем данных и мы хотим добавить RAM или диска
1. одни ноды отказывают, другие добавляются, чтобы заменить упавшие

## Фиксированное количество партиций

При создании хранилища задаем количество партиций. Их должно быть достаточно много, чтобы даные были распределены на достаточно небольшие кусочки. Это позволит при ребалансировке партиций между нодами перемещать партиции целиком, а не делать *split*. Например, видим рост нагрузки и добавляем ноду в кластер. Тогда просто берем с каждой имеющейся ноды N партиций(снижаем на них нагрузку) и переносим на новыцю ноду, чтобы в итоге на каждой ноде оказалась равномерная нагрузка.

Основная сложность - выбрать оптимальное количество партиций, причем приходится это делать сильно заранее, до начала работы хранилища:

- слишком маленькое количество может привести к очень крупным партициям. В итоге можно оказаться в ситуации, когда на каждой ноже по одной жирной партиции и дальше мы уже не можем распределять нагрузку, подключая новые ноды.
- слишком большое количество делает неоправданными ресурсы, которые придется затрачивать на обслуживание этих партиций. Потому что каждая из них должна учитываться в метаданных кластера, реплицироваться и проч.

Фиксированное количество партиций хорошо подходит для стратегии партиционирования [[Partition strategy|Hash of key]]. Но для [[Partition strategy|Range key]] работает не очень хорошо, потому что сочетание четкого определения диапазонов по партициям и четкое(причем на этапе создания хранилища) определение количества партиций делают вероятным неудачное разбиение, которое сложно будет изменить в дальнейшем. Для этого лучше подходит динамическая балансировка.

## Динамическая ребалансировака

Вместо фиксации количества партиций настраиваем лимит на размер партиции. При превышении лимита разделяем партицию на две и переносим половину на другую ноду. И наоборот, если диапазон для партиций выбран так, что они оказались незагруженными, то объединяем соседние партиции. Эти операции *split* и *merge* похожи на соответствующие операции для узлов [[B-tree]].
По большому счету с такой стратегием можно начинать с одной партиции и дальше адаптироваться под нагрузку. Но часто эффективно сразу начинать с небольшого количества партиций - *pre-splitting*.

## Пропорционально кол-ву нод

Предыдущие две стратегии основывались на объеме данных: либо сразу предполагали его и закладывали кол-ва партиций, либо адаптировались к нагрузке по ходу дела, определяя лимит на объем данных на партицию. Альтернативой является ориентация на количество нод и поддержание стабильным количества партиций на ноде:

1. при росте нагрузке добавляем ноды в кластер
1. делаем split партиций(рандомно или по какому-то алгоритмы)
1. одну часть партиции после split'a оставляем где была, другую переносим на новую ноду

Этот подход схож с [[Consistent hashing]], когда при разбиении на партиции учитывается "топология" кластера.

---

## Источники

1. [[Designing Data-Intensive Applications book ]]. Chapter 6.

## Ссылки

1. #[[Software/Architecture/Distributed systems/Partitioning/Basics]]
