---
date: 2024-03-08
---
# Two-phase commit(2PC)

Является одной из реализаций *atomic commit* (распределенная транзакция).

## Алгоритм

Алгоритм предполагает две роли для нод: координатор транзакции(*coordinator* или *transaction manager*) и участники(*participants*). После открытия транзакции координатор рассылает участникам команды в рамках транзакции. Затем приходит время коммита.

Выполнение коммита состоит из двух фаз:

1. **prepare**: координатор отправляет участникам запрос готов ли участник закоммитить транзакцию. Участники, проверив все ограничения, отвечают согласием или отказом.
1. **принятие решения**: координатор на основе ответов участников принимает решение о транзакции
    - если хотя бы один участник оветил на запрос prepare отказом, то координатор делает прерывает транзакцию и сообщает о своем решении всем участникам
    - если все участники ответили согласием, то координатор выполняет коммит: первым делом записывает решение в свой WAL, затем рассылает команду *commit* участникам.

## Точки невозврата

Клепман выделяет две точки невозврата, на которых основывается надежность алгоритма:

1. если участник ответил согласием, то тем самым он дает обещание (*promise*), что при необходимости он гарантирует, что успешно закомитит транзакцию. После согласия у участника уже нет возможности отказаться от коммита. Поэтому прежде чем ответить согласием каждый участник должен проверить все ограничения модели данных(уникальность, внешние ключи и др.), проверить доступное место на диске и любый другие условия. Плюс использовать блокировки, чтобы обеспечить требование [[ACID Isolation|isolation]] транзакции.
1. если координатор принял решение *commit/abort*, то оно уже неизменно. Принятие решения сводится к сохранению команды *commit/abort* в WAL на диск. После этого даже если координатор отказывает, то после restore он проанализирует WAL и поймет, что какие-то решения нужно продублировать участникам. А если участники окажутся недоступны, то координатор будет бесконечно ретраить отправку решения.

Получается, что распределенная операция сводится в итоге к и гарантируется локальными механизмами каждой ноды: блокировки на стороне участников, факт записи  команды *commit/abort* в WAL координатора.

## Обработка отказов

### Отказ координатора

Слабым местом алгоритма является отказ координатора. Если после получения ответов на *prepare* координатор отказывает, то выполнение алгоритма оказывается заблокировнным: нельзя ни произвести коммит, ни аборт транзакции. Такое состояние называется *in doubt* или *uncertain*, отому что только координатор может принять решение. Из-за этой особенности 2PC называется **блокирующим** алгоритмом.

Казалось бы не так уж страшно, что зависла транзакция. Но участники после того как ответили согласием на запрос prepare, связаны обещанием во что бы то ни стало закомитить изменения, если придет такая команда от координатора. А значит они должны использовать блокировки, чтобы избежать конфликтов конкуррентных транзакций. Пока координатор не восстановится участники обязаны держать эти блокировки. Это может привести к блокировке какой-то части функционала системы.

К неблокирующей реализации atomic commitment относят алгоритм Three-phase commit, но он для корректной работы требует гарантии [[Latency model|ограниченных(*bounded*) задержек сети]], что трудно обеспечить.

### Отказ участника

Если участник отказал и следовательно хотя бы один запрос *prepare* завершился по таймауту, то координатор откатывает транзакцию. Т.е. для работы алгоритма должны быть доступны все участники.

## Аналогия

Мартин Клепман сравнивает 2PC с процессом бракосочетания. Сначала представитель ЗАГСа(координатор) спрашивает согласие жениха и невесту(участников). Если кто-то не согласен, то церемония прерывается. После получения двух согласий отказываться уже поздно и теперь представитель должен объявить о заключении брака. Если невеста упала в обморок после того как сказала "да", то ей расскажут об итоге церемонии после того как она очнется.

---

## Источники

1. [[Designing Data-Intensive Applications book]]. Chapter 9.

## Ссылки

1. 
