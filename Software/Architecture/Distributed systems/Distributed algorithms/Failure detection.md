---
date: 2022-06-07
tags:
    - gossip
---

Подсистема *failure detector* является неотемлимой частью распределенной системы и отвечает за отслеживание состояния процессов в распределнной системе (нод кластера).
Своевременное обнаружение отказа(проблемы с нодой или сетью) позволяет:
1. избежать лишней нагрузки на сеть в ходе отправке упавшей ноде сообщений
1. избежать распространения ошибок
1. избежать каскадных отказов

## Свойства failure detection алгоритма

Failure detection алгоритм сам является распределенным алгоритмом и характеризуется следующими свойствами:
1. liveness - если нода отказала, то алгоритм это обнаружит
1. safety - если алгоритм пометил ноду как отказавшую, то она действительно отказала

Качество конкретной реализации алгоритма характеризуется:
1. полнота(*completeness*) - способность алгоритма в итоге обнаружить отказ
1. точность(*accuracy*) - вероятность ошибки(*false positives* или *false negatives*)
1. скорость обнаружения отказа (*efficiency*)

Точность и скорость являются компромисными характеристиками: чем более точный алгоритм обнаружения отказа, тем он менее быстрый и наоборот. Например нода может быть просто замедлилась(заработал *GC*) или сеть до ноды забилась и долго идут ping/heartbeats. Если алгоритм будет ждать **дольше**, то она может в итоге ответить и алгоритм **точно** определит, что нода отказала.


## Реализации

### Pings and heartbeatbeat

Это наиболее простые и понятные алгоритмы для обнаружения отказа. Основны на **ограничении по времени** (т.е. предполагает синхронную систему), за которое нода должна ответить на *ping* или послать *heartbeat*.

Причем pings/heartbeats - это не обязательно сообщения в явном виде. Так в RAFT лидер периодически рассылает текущее состояние лога, даже если от клиента не приходило запросов на запись. Эти сообщения помимо репликации служат еще heartbeat'ом, показывая фоловерам, что лидер жив.

Несмотря на простоту такие алгоритмы используются на практике, например в Akka

#### Outsourced heartbeats

Когда один процесс пингует другой, то отсутствие ответа может говорить либо о том, что процесс отказал, либо о том, что сеть между процессами нарушена. Чтобы исключить второй вариант пингующий процесс может отправить пинг, но не напрямую, а через другого соседа. Тогда возможно другая часть сети окажется в норме и такой непрямой пинг дойдет. В итоге можно избежать пометки процесса как отказавшего.

### Timeout free failure detector

Процессы обмениваются сообщениями со своими соседями. Сосед принимает сообщение, помечает(инкрементирует счетчик), что через него прошло сообщение и отправляет дальше. Главная задача - интерпретировать результаты счетчиков в передаваемых сообщениях и определить отказал ли кто-то.

### Phi-Accrual Failure Detector

Алгоритм вычисляет значение phi - вероятность того, что состояние процесса определено верно. Используется в Akka, Cassandrs.

### Gossip

Основывается gossip (gossip dissemination) протоколе для распространения информации о состоянии нод в кластере.

---

### Источники:
1. Alex Petrov. Database Internals. Failure detection.
1. [Timeout free detector. Курс «Распределенные системы». Лекция 6 (Олег Сухорослов)](https://www.youtube.com/watch?v=unMQXBgWrPQ&t=3319s)

### Ссылки:
1. [[Cascade failure]]
1. [[Software/Architecture/Software architecture/DDD/Basics]]
1. [[Failure detection allow consensus in async system]]
1. [[Gossip dissemination]]