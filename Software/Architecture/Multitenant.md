---
date: 2022-06-03
tags:
    - tenant
---

*Тенант* - это довольно абстрактное понятие, его можно описать как группу пользователей. Это может быть страна, заказчик-организация, команда, семья. В предельном случае каждый user = tenant.

Проще всего представить *multi-tenant* решение как SaaS, которое продается разным заказчикам. Например, Azure является multi-tenant облачной платформой, которая обслуживает разные бизнесы. K8s в рамках организации может быть использован разными командами разработки разных продуктов.

### Зачем multi-tenant? 

Multi-tenant решение позволяет использовать одни и те же ресурсы для обслуживания разных заказчиков, что снижает затраты на инфраструктуру и поддержку. В качестве ресурсов могут быть вычислительные мощности, хранилища данных.

Но multi-tenant решение вносит и дополнительную сложность: 
1. что такое тенант конкретно для вашего решения?
1. нужно учитывать разные требования тенантов(могут иметь разные требования по безопасности, производительности, функционалу и т.п.)
1. обеспечивать требуемый уровень изоляции между тенантами в соответствии с требованиями каждого заказчика
1. протестировать требуемый уровень изоляции
1. нужно избежать *noisy neighbor problem*
1. если тенанты используют разную инфраструктуру(например БД), то из-за этого может быть(при необходимости) сложно склеивать несколько тенантов в один
1. чтобы обновить сервис нужно договориться о возможном времени простоя со всеми тенантами, чтобы было удобно для всех
1. в общем для всех тенантов compute слое может быть кэширование в памяти. Проблемы с памятью могут возникнуть, если разным тенантам необходимо кэшировать разные данные, тогда объем кэша будет расти пропоруионально кол-ву тенантов

Эта дополнительная сложность может быть неоправдана, если у вашего решения предполагается небольшое кол-во тенантов.

Выбор конкретного решения (*tenant model*) определяется исходя из требований. Но главный принцип - это компромисс между **переиспользованием ресурсов**(экономия на их стоимости, поддержке и развитии) и **изоляцией**(определяется требованиями заказчиков)


## Tenant models

Переиспользование(или наоборот изоляция) может быть на разных уровнях:
1. уровень доменных имен
1. сетевой уровень
1. вычисление(compute)
1. хранение

В зависимости от требований что-то из этого может быть использовано совместно, а что-то должно быть развернуто идивидуально для каждого тенанта.

Кроме этого выделяют *физических* и *логических* тенантов. Логический тенант - это та самая группа пользователей. Физический - это фактически *deployment*, т.е. единица деплоя(единица инфраструктуры). Логические тенанты распределяются между физическими(деплойментами). Это похоже на физические и логические шарды + маппинг между ними.

**Пример 1:** на каждую страну(страна как тенант) может быть отдельный деплоймент, а уже внутри страны все заказчики(закачик как тенант) могут использовать один и тот же деплоймент.

**Пример 2:** есть несколько небольших заказчиков-тенантов и заказчик-крупняк с большой нагрузкой или строгими требованиями к изоляции данных. Тогда можно для крупняка сделать отдельный деплоймент, а все небольшие будут шарить один. 

Причем отдельный деплоймент может означать: отдельную БД, отдельный сервис(compute). Плюс возможны их комбинации.

## Жизненный цикл тенанта

Проектируя архитектуру multi-tenant решения необходимо подумать какие из этих этапов жизни тенанта актуальны для вашего сервиса:
1. trial - пробный этап, когда заказчик хочет попробовать ваше решение
1. onboarding - начало полноценного пользования сервисом
1. update - обновление сервиса для тенанта
1. scale - масштабирование исходя из потребностей тенанта
1. move tenants between infrastructure - например, перенос в другую страну
1. merge/split - компании/команды могут схлопываться или наоборот делиться на части
1. offboarding
1. deactivate

Каждый из этих этапов вызывает дополнительные вопросы важные для реализации решения

---

### Источники:
1. [Microsoft documentation](https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/overview)

### Ссылки:
1. [Noisy neighbor](https://docs.microsoft.com/en-us/azure/architecture/antipatterns/noisy-neighbor/noisy-neighbor)