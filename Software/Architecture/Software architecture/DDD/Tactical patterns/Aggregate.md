---
date: 2022-09-08
tags:
    - boundaries
---

*Агрегат* - это [[Entity]], собирающая в себе несколько *Entities* и [[Value object]]

*Корень агрегата* - одна из сущностей, которая предоставляет глобальный ID(ID остальных сущностей используются только внутри агрегата, но не глобально) и публичный API для взаимодействия с агрегатом

### Цель паттерна

Обеспечить **строгую согласованность** данных: проверка возможности выполнения запрашиваемой операции, соблюдение инвариантов, исключение частичного обновления данных(состояние агрегата меняется всегда целиком). Последнее также налагает ограничение на хранилище, которое должно обеспечить сохранение агрегата целиком в одной транзакции.

Для обеспечения согласованности агрегат должен обеспечить [[Incapsulation]] и исключить возможность непосредственно измененять состояния полей агргата извне. Все изменения происходят по средствам вызова публичного API агрегата, который должен формировать согласованную [[Abstraction]]. Таким подходом мы соблюдаем принцип [Tell don't ask](вставить ссылку!!!).

К публичному API агрегата также относятся [[Domain event]]

Строгая согласованность - это не только про то, что агрегат всегда сохраняется целиком, но и про то, что проверка возможности выполнения запрошенной операции также должна производится на основании согласованных данных. Если [[Application layer]] передает какие данные извне как параметр метода, то значит они были получены из другого агрегата, а значит по определению такие данные *eventually consistent*. При определении границ агрегата всегда нужно оценивать, что будет, если агрегат будет выполнять бизнес логику на основании eventually consistent данных. Если такие отклонения недопустимы в конкретном домене, то нужно включить необходимые данные в агрегат.


### Причины существования агрегата
1. в домене есть объекты, которые изменяются всегда вместе
1. в домене есть бизнес логика, затрагивающая сразу несколько объектов

---

### Источники:
1. Learning DDD. Chapter 6. Tackling complex business logic. Vladik Khononov

### Ссылки:
1. https://github.com/ddd-crew/aggregate-design-canvas
1. серия статей Вернона про проектирование агрегатов
1. статья ника тьюна
1. [[Eventual consistency]]
1. [[Concurrency control]]
1. статья вернона про NOSQL как хранилище агрегата


